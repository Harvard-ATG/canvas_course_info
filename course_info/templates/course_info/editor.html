{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
{% endblock %}

{% block extra_js %}
    <script type="text/javascript" charset="utf8">
        $(document).ready(function () {

            // Button functionality for "Insert as Widget" - updates the return-type to post to Canvas
            $('#iframe_submit').click(function() {
                $('#return_type').val("iframe");
            });

            // Button functionality for "Insert as Text"
            $('#oembed_submit').click(function() {
                $('#return_type').val("oembed");
                console.log("oembed submit?")
            });

            // Give Canvas the right information on Submit
            $('#widget_edit_form').submit(function(event){

                // set up the base url
                var p = $(location).attr('protocol');
                var h = $(location).attr('host');
                var widget_url = p + '//' + h + '/course_info/widget.html?course_instance_id={{ course_instance_id }}';

                // Only select once for efficiency's sake
                var return_type_val = $("#return_type").val();

                // perform the relevant actions for the desired return type
                if (return_type_val ==  "iframe") {
                    var widget_height = estimateHeight();
                    if (widget_height > 100 && widget_height < 1000) {
                        $("#widget_height").val(widget_height);
                    }
                } else if (return_type_val ==  "oembed") {
                    // ensure the correct configuration if indeed we're asking for some oEmbed
                    var endpoint_url = p + '//' + h + '/course_info/oembed';
                    $('#oembed_url').val(endpoint_url);
                }

                // modify the submission url to reflect the checked boxes
                // does this have to be 'f' or can we change it?
                // in this situation, I guess 'f' signifies "unchecked == false"
                $('#widget_edit_form input:checkbox:checked').each(
                        function(){
                            widget_url += '&amp;f=' + $(this).val();
                        }
                );

                $('#widget_url').val(widget_url);
            });

            //Is this obsolete debug code? Can we take it out?
            $(".course_info_checkbox").on("change", function(e) {
                console.log("widget height estimate changed to:", estimateHeight());
            });

            // See README for details on how to get resizing to work in Canvas.
            // This is a stand-in for a global js function that should be included in the Canvas site.
            // This function attempts to determine the content height for the checked fields.
            // This value will be used to set the "height" attribute of the iFrame so that
            // the content fits.
            function estimateHeight() {
                var $checked = $("#widget_edit_form_container input:checked");
                var $container = $('<div></div>');
                var height;

                $checked.each(function(idx) {
                    var $field = $(this).next().clone().wrap("<div></div>").parent();
                    $container.append($field);
                });

                h1 = $("#widget_edit_form_container").outerHeight();

                height = $container.hide().appendTo("body").height();
                $container.remove();

                //return height * 1.50; //fudge factor, better to go a little over than under.
                return h1;
            }
        });
    </script>
{% endblock %}

{% block content %}

    <div class="container-fluid">
        <h4>Please select the fields you wish to display from the list below.</h4>

        <h5>

            Then, select "Insert as Widget" to embed a live-updating widget to mirror your iSite
            {% if should_offer_text %}
                {# TODO: Get the leading whitespace out of the django printer so this comma lines up #}
                - or "Insert as Text" to place an editable table in the Canvas Editor
            {% endif %}

        </h5>

        <p>This information is provided by the registrar's office.
            If any of it is outdated or incorrect, please contact the catalog coordinator in your department.</p>
    </div>
    <br/>
    <div id="widget_edit_form_container" class="container-fluid">

        <form action="{{ launch_presentation_return_url }}" id="widget_edit_form" method="get">

            {# could use this {{ var.example.strip|safe|removetags:"p img" }}#}
            {% for field in fields %}
                <div>
                    <input type="checkbox" class="course_info_checkbox" id="{{ field.key }}" value="{{ field.key }}" checked/>
                    <span>{{ field.value }}</span>
                </div>
            {% endfor %}

            {# Many of these values are inserted dynamically by the JS above #}
            <input type="hidden" id="return_type"   name="return_type"  value=""/>
            <input type="hidden" id="oembed_url"    name="endpoint"     value=""/>
            <input type="hidden" id="widget_url"    name="url"          value=""/>
            <input type="hidden"                    name="width"        value="100%"        />
            <input type="hidden" id="widget_height" name="height"       value=""            />
            <input type="hidden"                    name="title"        value="Course Info" />
            <input type="hidden"                    name="id"           value="InfoFrame" />
            <br/>
            <input type="submit" class="btn btn-default" id="iframe_submit" name="iframe_submit" value="Insert as Widget"/>

            {% if should_offer_text %}
                <input type="submit" class="btn btn-default" id="oembed_submit" name="oembed_submit" value="Insert as Text"/>
            {% endif %}

        </form>
        <br/>
    </div>
{% endblock %}